name: X Auto Post (queue from Sheet at 00:00 & 02:00 JST)

on:
  schedule:
    - cron: "0 15 * * *"  # JST 00:00（UTC 15:00）
    - cron: "0 17 * * *"  # JST 02:00（UTC 17:00）
  workflow_dispatch:
    inputs:
      force_run:
        description: "手動テストで即実行（yes で実行）"
        required: false
        default: "yes"

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo

      # --- Google Sheets ---
      SHEET_ID: ${{ secrets.SHEET_ID }}
      GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
      SHEET_TAB: x_autopost_yoru

      # --- X API keys ---
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}

      # --- キュー方式: 1件だけ投稿 ---
      FORCE_ONE: "1"
      DRY_RUN: "0"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run poster (queue 1 item)
        run: |
          python auto_post.py
