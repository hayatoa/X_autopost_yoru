name: X Auto Post (manual)

on:
  workflow_dispatch:
    inputs:
      force_post:
        description: "0000 or 0200（どちらを投げるか）"
        required: true
        default: "0000"

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Tokyo
      X_API_KEY: ${{ secrets.X_API_KEY }}
      X_API_SECRET: ${{ secrets.X_API_SECRET }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
      X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
      TEXT_0000: "深夜0時の手動テスト {date} {time}"
      TEXT_0200: "深夜2時の手動テスト {date} {time}"
      FORCE_WHICH: ${{ github.event.inputs.force_post }}
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          pip install requests requests-oauthlib
      - run: |
          python - <<'PY'
          import os, datetime as dt, requests
          from requests_oauthlib import OAuth1
          JST = dt.timezone(dt.timedelta(hours=9)); now = dt.datetime.now(JST)
          which = (os.environ.get("FORCE_WHICH") or "0000").strip()
          text = os.environ["TEXT_0000"] if which=="0000" else os.environ["TEXT_0200"]
          text = text.format(date=now.strftime("%Y-%m-%d"), time=now.strftime("%H:%M"))
          print("[INFO] posting:", text)
          auth = OAuth1(os.environ["X_API_KEY"], os.environ["X_API_SECRET"],
                        os.environ["X_ACCESS_TOKEN"], os.environ["X_ACCESS_TOKEN_SECRET"],
                        signature_method="HMAC-SHA1")
          r = requests.post("https://api.twitter.com/2/tweets", auth=auth, json={"text": text})
          print("[HTTP]", r.status_code, r.text[:200]); r.raise_for_status()
          print("[OK] tweeted id=", r.json().get("data",{}).get("id"))
          PY
